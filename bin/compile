#!/usr/bin/env bash
buildPackPath=$(cd "$(dirname "${0:-}")"; cd ..; pwd)
source $buildPackPath/lib/utils
buildDir=$1
profileDir=$buildDir/.profile.d
profileScript=$profileDir/js-dist.sh
buildCommand=${BUILDPACK_COMMAND:-"npm run build"}
if [ ! -d $buildDir ];
then
    logError "Build dir not exists"
    exit 1
fi
logDebug "Procesing 'compile' stage in build directory '$buildDir'"
pkgJson=$( findPkgJson $buildDir )
pkgJsonDirectory=$( dirname $pkgJson )
if [ $pkgJsonDirectory != $buildDir ];
then
    logWarn "File package.json founded in '$pkgJsonDirectory' directory"
fi
logInfo "Installing npm in '$HOME' directory"
installNpm
logInfo "Building project using '$buildCommand' command in '$pkgJsonDirectory' directory"
distDir=${BUILDPACK_DIST:-dist}
targetDistDir="$buildDir/$distDir"
cd $pkgJsonDirectory
npm install
$buildCommand
logInfo "Copying distribution directory '$distDir' in '$targetDistDir'"
cp -R $distDir $targetDistDir
mkdir -p $profileDir
logInfo "Creating  '$profileScript' script with 'JS_DIST_DIR' environment variable with '$targetDistDir' value"
echo "export JS_DIST_DIR=$targetDistDir" > $profileScript